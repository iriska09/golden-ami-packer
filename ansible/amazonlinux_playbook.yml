---
- name: CIS Level 1 Hardening - Amazon Linux 2023
  hosts: all
  become: true
  gather_facts: true

  vars:
    sshd_config_path: /etc/ssh/sshd_config
    ansible_pkg_mgr: dnf  # Force package manager to dnf

  tasks:
    - name: Ensure security packages are installed
      ansible.builtin.dnf:
        name:
          - audit
          - cronie
          - fail2ban
        state: present
        use_backend: dnf5  # Explicitly specify backend

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: "{{ sshd_config_path }}"
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        validate: '/usr/sbin/sshd -t -f %s'
      notify: restart sshd

    - name: Configure automatic security updates
      ansible.builtin.cron:
        name: "Automatic security updates"
        minute: "0"
        hour: "2"
        job: "dnf -y update --security"

  handlers:
    - name: restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted