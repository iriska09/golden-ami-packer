---
- name: Harden Amazon Linux 2023 AMI
  hosts: localhost
  become: true
  tasks:
    - name: Disable password authentication
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
        backup: yes

    - name: Set SSH protocol to 2
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Protocol'
        line: 'Protocol 2'
        state: present
        backup: yes

    - name: Disable root login
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backup: yes

    - name: Disable empty passwords
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitEmptyPasswords'
        line: 'PermitEmptyPasswords no'
        state: present
        backup: yes

    - name: Set MaxAuthTries to 3
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?MaxAuthTries'
        line: 'MaxAuthTries 3'
        state: present
        backup: yes

    - name: Check if sshd service exists (Amazon Linux 2023)
      stat:
        path: /usr/lib/systemd/system/sshd.service
      register: sshd_service

    - name: Restart SSH service if available
      ansible.builtin.systemd:
        name: sshd
        state: restarted
      when: sshd_service.stat.exists
      ignore_errors: true
